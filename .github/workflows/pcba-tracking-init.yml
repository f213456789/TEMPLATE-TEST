name: PCBA Tracking - Init Folder, Links, Sub-Issues

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: write

jobs:
  init:
    if: contains(github.event.issue.labels.*.name, 'pcb-tracking')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse project code from issue title/body
        id: parse
        shell: bash
        run: |
          set -e
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"

          CODE="$(printf "%s\n%s\n" "$TITLE" "$BODY" | grep -Eo 'VB[0-9]{4}' | head -n 1 || true)"
          if [ -z "$CODE" ]; then
            echo "code=" >> $GITHUB_OUTPUT
            exit 0
          fi

          PREFIX="${CODE:0:4}xx"
          echo "code=$CODE" >> $GITHUB_OUTPUT
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT

      - name: Create folder structure
        if: steps.parse.outputs.code != ''
        shell: bash
        run: |
          set -e
          CODE="${{ steps.parse.outputs.code }}"
          PREFIX="${{ steps.parse.outputs.prefix }}"
          BASE="Project/${PREFIX}/${CODE}"

          mkdir -p "${BASE}"/{01_Gerber,02_3D,03_2D,04_PnP,05_Sticker_Silk,06_Inspection_Index,07_DXF,08_Marking_ICDM,09_GRR_Report}

          for d in "${BASE}"/*; do
            touch "$d/.gitkeep"
          done

          cat > "${BASE}/README.md" << EOF
          # PCBA Data Package - ${CODE}
          Please upload files to corresponding folders.
          EOF

      - name: Commit & push
        if: steps.parse.outputs.code != ''
        shell: bash
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git add Project/
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Init PCBA folders for ${{ steps.parse.outputs.code }} (issue #${{ github.event.issue.number }})"
          git push

      # âœ… 1) æ¯ Issue ç•™è¨€ï¼šæ¯é …é™„è³‡æ–™å¤¾é€£çµ
      - name: Comment checklist with per-folder links
        if: steps.parse.outputs.code != ''
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const code = "${{ steps.parse.outputs.code }}";
            const prefix = "${{ steps.parse.outputs.prefix }}";
            const base = `Project/${prefix}/${code}`;
            const branch = (context.ref || "refs/heads/master").replace("refs/heads/", "");
            const baseUrl = `https://github.com/${owner}/${repo}/tree/${branch}/${base}`;

            const items = [
              { key: "02_3D",  name: "PCBA 3D åœ–æª”ï¼ˆå«å…ƒä»¶æ“ºæ”¾ï¼å«é«˜åº¦ï¼‰", folder: "02_3D" },
              { key: "03_2D",  name: "PCBA 2D å°ºå¯¸åœ–ï¼ˆå«æ¿å¤–å½¢ã€å­”ä½/å°ºå¯¸ç­‰ï¼‰", folder: "03_2D" },
              { key: "05_Sticker_Silk", name: "PCBA Sticker / Silkï¼ˆçµ²å°ï¼è²¼ç´™åœ–ï¼‰", folder: "05_Sticker_Silk" },
              { key: "01_Gerber", name: "Gerberï¼šå«æ¿å±¤ Gerber æª”", folder: "01_Gerber" },
              { key: "04_PnP", name: "Pick & Place / è²¼ç‰‡åº§æ¨™ï¼ˆå«æ—‹è½‰è§’ã€é¢åˆ¥ï¼‰", folder: "04_PnP" },
              { key: "06_Inspection_Index", name: "PCBA Inspection Indexï¼šæª¢æ¸¬é …ç›®ï¼ˆAOI/ICT/åŠŸèƒ½æ¸¬ç­‰ï¼‰", folder: "06_Inspection_Index" },
              { key: "07_DXF", name: "PCBA è“‹æ¿åœ–ï¼šDXF æª”", folder: "07_DXF" },
              { key: "08_Marking_ICDM", name: "PCBA æ–‡å­—å°åˆ·ï¼ˆMarking/Labelï¼‰/ ICDM LISTï¼šå‘½åè¦å‰‡", folder: "08_Marking_ICDM" },
              { key: "09_GRR_Report", name: "GRR Reportï¼šGRR å ±å‘Šï¼ˆå¦‚é©ç”¨ï¼‰", folder: "09_GRR_Report" },
            ];

            const checklistLines = items.map(i => {
              const link = `${baseUrl}/${i.folder}`;
              return `- [ ] ${i.name}  \n  ğŸ“ Folderï¼š${link}`;
            }).join("\n");

            const body = [
              `## å°ˆæ¡ˆè³‡æ–™ä¸Šå‚³æª¢æ ¸ï¼ˆå«æ¯é …è³‡æ–™å¤¾é€£çµï¼‰`,
              ``,
              `- å°ˆæ¡ˆ/æ¿è™Ÿï¼š **${code}**`,
              `- Repo ç›®çš„åœ°ï¼š \`${base}/\``,
              `- ä¸Šå‚³ç¸½è¦½ï¼ˆGitHub treeï¼‰ï¼š ${baseUrl}`,
              ``,
              `### âœ… æª¢æ ¸æ¸…å–®ï¼ˆé€é …ä¸Šå‚³åˆ°å°æ‡‰è³‡æ–™å¤¾ï¼‰`,
              checklistLines,
              ``,
              `### è¦å‰‡`,
              `- è«‹å°‡è³‡æ–™ä¾é¡åˆ¥/ç‰ˆæœ¬åˆ†é¡æ•´ç†ï¼ˆå·²æä¾›é è¨­ç›®éŒ„ï¼‰`,
              `- å®Œæˆå¾Œè«‹åœ¨æœ¬ Issue å‹¾é¸å®Œæˆé …ç›®ï¼Œä¸¦é™„ä¸Š PR / Commit / å­ Issue é€£çµï¼ˆå¦‚æœ‰ï¼‰`,
              ``,
              `### è£œå……èªªæ˜`,
              `ï¼ˆè«‹åœ¨æ­¤è£œå……ï¼šç¼ºä»¶åŸå› ã€ç‰ˆæœ¬å·®ç•°ã€PR/Commit é€£çµâ€¦ï¼‰`,
            ].join("\n");

            await github.rest.issues.createComment({ owner, repo, issue_number, body });

      # âœ… 2) è‡ªå‹•å»ºç«‹å­ Issueï¼ˆSub-issuesï¼‰
      - name: Create sub-issues for each checklist item
        if: steps.parse.outputs.code != ''
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const parent = context.payload.issue;
            const parentNumber = parent.number;
            const code = "${{ steps.parse.outputs.code }}";
            const prefix = "${{ steps.parse.outputs.prefix }}";
            const base = `Project/${prefix}/${code}`;
            const branch = (context.ref || "refs/heads/master").replace("refs/heads/", "");
            const baseUrl = `https://github.com/${owner}/${repo}/tree/${branch}/${base}`;

            // å¯é¸ï¼šçµ¦å­issueä¸€å€‹labelï¼Œæ–¹ä¾¿ç¯©é¸ï¼ˆä½ è¦å…ˆåœ¨repoå»ºå¥½ label: pcb-subï¼‰
            const childLabels = ["pcb-sub"];

            const items = [
              { id: "01", title: "Upload Gerber", folder: "01_Gerber", desc: "Gerber æª”æ¡ˆä¸Šå‚³èˆ‡ç‰ˆæœ¬ç¢ºèª" },
              { id: "02", title: "Upload 3D", folder: "02_3D", desc: "3Dï¼ˆå«é«˜åº¦ï¼‰ä¸Šå‚³èˆ‡ç¢ºèª" },
              { id: "03", title: "Upload 2D", folder: "03_2D", desc: "2D å°ºå¯¸åœ–ï¼ˆå¤–å½¢/å­”ä½/å°ºå¯¸ï¼‰ä¸Šå‚³èˆ‡ç¢ºèª" },
              { id: "04", title: "Upload PnP", folder: "04_PnP", desc: "Pick&Place åº§æ¨™ï¼ˆè§’åº¦/é¢åˆ¥ï¼‰ä¸Šå‚³èˆ‡ç¢ºèª" },
              { id: "05", title: "Upload Sticker/Silk", folder: "05_Sticker_Silk", desc: "çµ²å°/è²¼ç´™åœ–ä¸Šå‚³èˆ‡ç¢ºèª" },
              { id: "06", title: "Upload Inspection Index", folder: "06_Inspection_Index", desc: "æª¢æ¸¬é …ç›®ï¼ˆAOI/ICT/åŠŸèƒ½æ¸¬ï¼‰ä¸Šå‚³èˆ‡ç¢ºèª" },
              { id: "07", title: "Upload DXF", folder: "07_DXF", desc: "è“‹æ¿åœ– DXF ä¸Šå‚³èˆ‡ç¢ºèª" },
              { id: "08", title: "Upload Marking/ICDM", folder: "08_Marking_ICDM", desc: "Marking/Labelã€ICDM å‘½åè¦å‰‡ä¸Šå‚³èˆ‡ç¢ºèª" },
              { id: "09", title: "Upload GRR Report", folder: "09_GRR_Report", desc: "GRR å ±å‘Šï¼ˆå¦‚é©ç”¨ï¼‰ä¸Šå‚³èˆ‡ç¢ºèª" },
            ];

            // é¿å…é‡è¤‡å»ºç«‹ï¼šç”¨åŒæ¨£çš„æ¨™é¡Œå‰ç¶´æœå°‹ç¾æœ‰ issue
            const prefixTitle = `[${code}]`;
            const existing = await github.rest.issues.listForRepo({
              owner, repo, state: "all", per_page: 100
            });
            const existingTitles = new Set(existing.data.map(x => x.title));

            const created = [];
            for (const it of items) {
              const childTitle = `${prefixTitle} ${it.title}`;
              if (existingTitles.has(childTitle)) {
                continue;
              }

              const folderUrl = `${baseUrl}/${it.folder}`;
              const childBody = [
                `### ${it.desc}`,
                ``,
                `- å°ˆæ¡ˆï¼š**${code}**`,
                `- å°æ‡‰è³‡æ–™å¤¾ï¼š ${folderUrl}`,
                `- æ¯ Issueï¼š #${parentNumber}`,
                ``,
                `#### å®Œæˆæ¢ä»¶`,
                `- [ ] æª”æ¡ˆå·²ä¸Šå‚³åˆ°è³‡æ–™å¤¾`,
                `- [ ] æª”æ¡ˆå‘½å/ç‰ˆæœ¬ç¢ºèª`,
                `- [ ] å¦‚æœ‰å·®ç•°ï¼Œè£œå……åŸå› èˆ‡ç›¸é—œ PR/Commit é€£çµ`,
              ].join("\n");

              const res = await github.rest.issues.create({
                owner, repo,
                title: childTitle,
                body: childBody,
                labels: childLabels,
                assignees: parent.assignees?.length ? parent.assignees.map(a => a.login) : [parent.user.login],
              });

              created.push(res.data.number);
            }

            // åœ¨æ¯ issue è²¼ä¸Š task listï¼ˆæœƒé€£åˆ°å­ issueï¼‰
            if (created.length) {
              const lines = created.map(n => `- [ ] #${n}`).join("\n");
              const comment = [
                `## å·²è‡ªå‹•å»ºç«‹å­ Issueï¼ˆSubï¼‰`,
                `è«‹ä¾åºå®Œæˆä¸¦é—œé–‰å­ Issueï¼š`,
                ``,
                lines
              ].join("\n");

              await github.rest.issues.createComment({
                owner, repo, issue_number: parentNumber, body: comment
              });
            }
