name: PCBA Tracking - Init Folder & Sub-Issue (Final)

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: write

jobs:
  init:
    if: contains(github.event.issue.labels.*.name, 'pcb-tracking')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =====================================================
      # 1ï¸âƒ£ Parse Issue Content (Project Code + Owners)
      # =====================================================
      - name: Parse issue content
        id: parse
        shell: bash
        run: |
          set -e
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"

          CODE="$(printf "%s\n%s\n" "$TITLE" "$BODY" | grep -Eo 'VB[0-9]{4}' | head -n 1 || true)"
          if [ -z "$CODE" ]; then
            echo "code=" >> $GITHUB_OUTPUT
            exit 0
          fi

          PREFIX="${CODE:0:4}xx"

          get_field () {
            echo "$BODY" | grep -A1 "$1" | tail -n1 | xargs || true
          }

          echo "code=$CODE" >> $GITHUB_OUTPUT
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT

          echo "gerber=$(get_field 'Gerber æª”æ¡ˆè² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "owner3d=$(get_field '3D åœ–æª”è² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "owner2d=$(get_field '2D åœ–æª”è² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "pnp=$(get_field 'Pick & Place')" >> $GITHUB_OUTPUT
          echo "sticker=$(get_field 'Sticker')" >> $GITHUB_OUTPUT
          echo "inspection=$(get_field 'Inspection')" >> $GITHUB_OUTPUT
          echo "dxf=$(get_field 'DXF')" >> $GITHUB_OUTPUT
          echo "marking=$(get_field 'Marking')" >> $GITHUB_OUTPUT
          echo "grr=$(get_field 'GRR')" >> $GITHUB_OUTPUT

      # =====================================================
      # 2ï¸âƒ£ Create Folder Structure
      # =====================================================
      - name: Create folder structure
        if: steps.parse.outputs.code != ''
        run: |
          CODE="${{ steps.parse.outputs.code }}"
          PREFIX="${{ steps.parse.outputs.prefix }}"
          BASE="Project/${PREFIX}/${CODE}"

          mkdir -p "${BASE}"/{01_Gerber,02_3D,03_2D,04_PnP,05_Sticker_Silk,06_Inspection_Index,07_DXF,08_Marking_ICDM,09_GRR_Report}
          for d in "${BASE}"/*; do touch "$d/.gitkeep"; done

          echo "# PCBA Data Package - ${CODE}" > "${BASE}/README.md"

      - name: Commit folders
        if: steps.parse.outputs.code != ''
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add Project/
          git diff --cached --quiet || git commit -m "Init PCBA folders for ${{ steps.parse.outputs.code }}"
          git push

      # =====================================================
      # 3ï¸âƒ£ Create Sub-Issues (Safe Assign + Real @)
      # =====================================================
      - name: Create sub-issues (safe assign)
        if: steps.parse.outputs.code != ''
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const parent = context.payload.issue;
            const parentNumber = parent.number;

            const clean = s => s ? s.trim() : s;

            const code   = "${{ steps.parse.outputs.code }}";
            const prefix = "${{ steps.parse.outputs.prefix }}";
            const branch = (context.ref || "refs/heads/main").replace("refs/heads/", "");
            const baseUrl = `https://github.com/${owner}/${repo}/tree/${branch}/Project/${prefix}/${code}`;

            const ownersByFolder = {
              "01_Gerber":           ["${{ steps.parse.outputs.gerber }}"],
              "02_3D":               ["${{ steps.parse.outputs.owner3d }}"],
              "03_2D":               ["${{ steps.parse.outputs.owner2d }}"],
              "04_PnP":              ["${{ steps.parse.outputs.pnp }}"],
              "05_Sticker_Silk":     ["${{ steps.parse.outputs.sticker }}"],
              "06_Inspection_Index": ["${{ steps.parse.outputs.inspection }}"],
              "07_DXF":              ["${{ steps.parse.outputs.dxf }}"],
              "08_Marking_ICDM":     ["${{ steps.parse.outputs.marking }}"],
              "09_GRR_Report":       ["${{ steps.parse.outputs.grr }}"],
            };

            const items = [
              ["Upload Gerber","01_Gerber","Gerber æª”æ¡ˆä¸Šå‚³èˆ‡ç¢ºèª"],
              ["Upload 3D","02_3D","3D åœ–æª”ä¸Šå‚³èˆ‡ç¢ºèª"],
              ["Upload 2D","03_2D","2D åœ–æª”ä¸Šå‚³èˆ‡ç¢ºèª"],
              ["Upload PnP","04_PnP","Pick & Place ä¸Šå‚³èˆ‡ç¢ºèª"],
              ["Upload Sticker/Silk","05_Sticker_Silk","Sticker / Silk ä¸Šå‚³"],
              ["Upload Inspection Index","06_Inspection_Index","Inspection Index ä¸Šå‚³"],
              ["Upload DXF","07_DXF","DXF è“‹æ¿åœ–ä¸Šå‚³"],
              ["Upload Marking/ICDM","08_Marking_ICDM","Marking / ICDM ä¸Šå‚³"],
              ["Upload GRR","09_GRR_Report","GRR Report ä¸Šå‚³"],
            ];

            for (const [title, folder, desc] of items) {
              const raw = ownersByFolder[folder] || [];
              const assignees = raw.map(clean).filter(Boolean);
              const folderUrl = `${baseUrl}/${folder}`;

              let issue;
              let assigned = false;

              try {
                issue = await github.rest.issues.create({
                  owner, repo,
                  title: `[${code}] ${title}`,
                  body: `### ${desc}\n\nğŸ“ ${folderUrl}\n\næ¯ Issueï¼š#${parentNumber}`,
                  assignees,
                  labels: ["pcb-sub"],
                });
                assigned = true;
              } catch (e) {
                issue = await github.rest.issues.create({
                  owner, repo,
                  title: `[${code}] ${title}`,
                  body: `### ${desc}\n\nğŸ“ ${folderUrl}\n\næ¯ Issueï¼š#${parentNumber}`,
                  labels: ["pcb-sub"],
                });
              }

              const mention = assigned
                ? assignees.map(u => `@${u}`).join(" ")
                : "âš ï¸ ç„¡æ³•è‡ªå‹• @ï¼ˆusername éŒ¯èª¤æˆ–æœªåŠ å…¥ Repoï¼‰";

              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issue.data.number,
                body: [
                  mention,
                  ``,
                  `è«‹å®Œæˆ **${desc}**`,
                  ``,
                  `ğŸ“ è³‡æ–™å¤¾ï¼š`,
                  folderUrl,
                  ``,
                  `ğŸ‘¤ å¡«å¯«çš„è² è²¬äººï¼š`,
                  assignees.join(", ") || "ï¼ˆæœªå¡« / email / username éŒ¯èª¤ï¼‰",
                  ``,
                  `å¦‚æœ‰éœ€è¦ï¼Œè«‹æ‰‹å‹•ä¿®æ­£ Sub-Issue assigneeã€‚`
                ].join("\n")
              });
            }
