name: PCBA Tracking - Init Folder & Sub-Issue (Final)

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: write

jobs:
  init:
    if: contains(github.event.issue.labels.*.name, 'pcb-tracking')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =====================================================
      # 1ï¸âƒ£ Parse Issue Content (Project Code + Owners)
      #   - Match Issue Template labels EXACTLY
      #   - Robust parsing with "### <label>"
      # =====================================================
      - name: Parse issue content
        id: parse
        shell: bash
        run: |
          set -e
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"

          CODE="$(printf "%s\n%s\n" "$TITLE" "$BODY" | grep -Eo 'VB[0-9]{4}' | head -n 1 || true)"
          if [ -z "$CODE" ]; then
            echo "code=" >> $GITHUB_OUTPUT
            exit 0
          fi

          PREFIX="${CODE:0:4}xx"

          # robust: find the line after "### <label>"
          get_field () {
            echo "$BODY" | grep -A1 "### $1" | tail -n1 | xargs || true
          }

          echo "code=$CODE" >> $GITHUB_OUTPUT
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT

          # MUST match your Issue Template labels exactly:
          echo "gerber=$(get_field 'Gerber æª”æ¡ˆè² è²¬äººï¼ˆGitHub username æˆ– emailï¼‰')" >> $GITHUB_OUTPUT
          echo "owner3d=$(get_field '3D åœ–æª”è² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "owner2d=$(get_field '2D åœ–æª”è² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "pnp=$(get_field 'Pick & Place è² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "sticker=$(get_field 'Sticker / Silk è² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "inspection=$(get_field 'Inspection Index è² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "dxf=$(get_field 'DXF è“‹æ¿åœ–è² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "marking=$(get_field 'Marking / ICDM è² è²¬äºº')" >> $GITHUB_OUTPUT
          echo "grr=$(get_field 'GRR Report è² è²¬äºº')" >> $GITHUB_OUTPUT

      # =====================================================
      # 2ï¸âƒ£ Create Folder Structure
      # =====================================================
      - name: Create folder structure
        if: steps.parse.outputs.code != ''
        run: |
          CODE="${{ steps.parse.outputs.code }}"
          PREFIX="${{ steps.parse.outputs.prefix }}"
          BASE="Project/${PREFIX}/${CODE}"

          mkdir -p "${BASE}"/{01_Gerber,02_3D,03_2D,04_PnP,05_Sticker_Silk,06_Inspection_Index,07_DXF,08_Marking_ICDM,09_GRR_Report}
          for d in "${BASE}"/*; do touch "$d/.gitkeep"; done

          echo "# PCBA Data Package - ${CODE}" > "${BASE}/README.md"

      - name: Commit folders
        if: steps.parse.outputs.code != ''
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add Project/
          git diff --cached --quiet || git commit -m "Init PCBA folders for ${{ steps.parse.outputs.code }}"
          git push

      # =====================================================
      # 3ï¸âƒ£ Comment checklist with per-folder links (optional but useful)
      # =====================================================
      - name: Comment checklist with per-folder links
        if: steps.parse.outputs.code != ''
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const code = "${{ steps.parse.outputs.code }}";
            const prefix = "${{ steps.parse.outputs.prefix }}";
            const branch = (context.ref || "refs/heads/main").replace("refs/heads/", "");
            const base = `Project/${prefix}/${code}`;
            const baseUrl = `https://github.com/${owner}/${repo}/tree/${branch}/${base}`;

            const items = [
              { name: "Gerberï¼šå«æ¿å±¤ Gerber æª”", folder: "01_Gerber" },
              { name: "PCBA 3D åœ–æª”ï¼ˆå«å…ƒä»¶æ“ºæ”¾ï¼å«é«˜åº¦ï¼‰", folder: "02_3D" },
              { name: "PCBA 2D å°ºå¯¸åœ–ï¼ˆå«æ¿å¤–å½¢ã€å­”ä½/å°ºå¯¸ç­‰ï¼‰", folder: "03_2D" },
              { name: "Pick & Place / è²¼ç‰‡åº§æ¨™ï¼ˆå«æ—‹è½‰è§’ã€é¢åˆ¥ï¼‰", folder: "04_PnP" },
              { name: "PCBA Sticker / Silkï¼ˆçµ²å°ï¼è²¼ç´™åœ–ï¼‰", folder: "05_Sticker_Silk" },
              { name: "PCBA Inspection Indexï¼šæª¢æ¸¬é …ç›®ï¼ˆAOI/ICT/åŠŸèƒ½æ¸¬ç­‰ï¼‰", folder: "06_Inspection_Index" },
              { name: "PCBA è“‹æ¿åœ–ï¼šDXF æª”", folder: "07_DXF" },
              { name: "PCBA æ–‡å­—å°åˆ·ï¼ˆMarking/Labelï¼‰/ ICDM LISTï¼šå‘½åè¦å‰‡", folder: "08_Marking_ICDM" },
              { name: "GRR Reportï¼šGRR å ±å‘Šï¼ˆå¦‚é©ç”¨ï¼‰", folder: "09_GRR_Report" },
            ];

            const lines = items.map(i => `- [ ] ${i.name}\n  ğŸ“ Folderï¼š${baseUrl}/${i.folder}`).join("\n");

            const body = [
              `## å°ˆæ¡ˆè³‡æ–™ä¸Šå‚³æª¢æ ¸ï¼ˆå«æ¯é …è³‡æ–™å¤¾é€£çµï¼‰`,
              ``,
              `- å°ˆæ¡ˆ/æ¿è™Ÿï¼š **${code}**`,
              `- Repo ç›®çš„åœ°ï¼š \`${base}/\``,
              `- ä¸Šå‚³ç¸½è¦½ï¼š ${baseUrl}`,
              ``,
              `### âœ… æª¢æ ¸æ¸…å–®`,
              lines,
            ].join("\n");

            await github.rest.issues.createComment({ owner, repo, issue_number, body });

      # =====================================================
      # 4ï¸âƒ£ Create Sub-Issues (Safe Assign + Email Fallback + Real @)
      # =====================================================
      - name: Create sub-issues (safe assign)
        if: steps.parse.outputs.code != ''
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const parent = context.payload.issue;
            const parentNumber = parent.number;

            const clean = s => (s ? s.trim() : "");
            const isEmail = s => /@/.test(s);

            const code   = "${{ steps.parse.outputs.code }}";
            const prefix = "${{ steps.parse.outputs.prefix }}";
            const branch = (context.ref || "refs/heads/main").replace("refs/heads/", "");
            const baseUrl = `https://github.com/${owner}/${repo}/tree/${branch}/Project/${prefix}/${code}`;

            // From Issue Template parsed values:
            const ownersByFolder = {
              "01_Gerber":           clean("${{ steps.parse.outputs.gerber }}"),
              "02_3D":               clean("${{ steps.parse.outputs.owner3d }}"),
              "03_2D":               clean("${{ steps.parse.outputs.owner2d }}"),
              "04_PnP":              clean("${{ steps.parse.outputs.pnp }}"),
              "05_Sticker_Silk":     clean("${{ steps.parse.outputs.sticker }}"),
              "06_Inspection_Index": clean("${{ steps.parse.outputs.inspection }}"),
              "07_DXF":              clean("${{ steps.parse.outputs.dxf }}"),
              "08_Marking_ICDM":     clean("${{ steps.parse.outputs.marking }}"),
              "09_GRR_Report":       clean("${{ steps.parse.outputs.grr }}"),
            };

            // Default fallback assignee when input is email/empty/wrong:
            const fallbackAssignees = (parent.assignees?.length ? parent.assignees.map(a => a.login) : [parent.user.login]);

            const items = [
              ["Upload Gerber","01_Gerber","Gerber æª”æ¡ˆä¸Šå‚³èˆ‡ç¢ºèª"],
              ["Upload 3D","02_3D","3D åœ–æª”ä¸Šå‚³èˆ‡ç¢ºèª"],
              ["Upload 2D","03_2D","2D åœ–æª”ä¸Šå‚³èˆ‡ç¢ºèª"],
              ["Upload PnP","04_PnP","Pick & Place ä¸Šå‚³èˆ‡ç¢ºèª"],
              ["Upload Sticker/Silk","05_Sticker_Silk","Sticker / Silk ä¸Šå‚³"],
              ["Upload Inspection Index","06_Inspection_Index","Inspection Index ä¸Šå‚³"],
              ["Upload DXF","07_DXF","DXF è“‹æ¿åœ–ä¸Šå‚³"],
              ["Upload Marking/ICDM","08_Marking_ICDM","Marking / ICDM ä¸Šå‚³"],
              ["Upload GRR","09_GRR_Report","GRR Report ä¸Šå‚³"],
            ];

            for (const [title, folder, desc] of items) {
              const inputOwner = ownersByFolder[folder];         // may be username or email
              const folderUrl = `${baseUrl}/${folder}`;

              // Decide assignee list:
              // - if input is a username (no '@') -> try assign that username
              // - if input looks like email/empty -> fallback to parent assignee/creator
              const desiredAssignees = (inputOwner && !isEmail(inputOwner)) ? [inputOwner] : fallbackAssignees;

              let issue;
              let assigned = false;
              let usedAssignees = desiredAssignees;

              try {
                issue = await github.rest.issues.create({
                  owner, repo,
                  title: `[${code}] ${title}`,
                  body: [
                    `### ${desc}`,
                    ``,
                    `ğŸ“ ${folderUrl}`,
                    ``,
                    `æ¯ Issueï¼š#${parentNumber}`,
                  ].join("\n"),
                  assignees: desiredAssignees,
                  labels: ["pcb-sub"],
                });
                assigned = true;
              } catch (e) {
                // If assign failed, create without assignees (do NOT break)
                issue = await github.rest.issues.create({
                  owner, repo,
                  title: `[${code}] ${title}`,
                  body: [
                    `### ${desc}`,
                    ``,
                    `ğŸ“ ${folderUrl}`,
                    ``,
                    `æ¯ Issueï¼š#${parentNumber}`,
                  ].join("\n"),
                  labels: ["pcb-sub"],
                });
                assigned = false;
                usedAssignees = [];
              }

              // Mention policy:
              // - Only mention when we successfully assigned a valid GitHub username
              // - Email cannot be @mentioned
              let mentionLine = "âš ï¸ ç„¡æ³•è‡ªå‹• @ï¼ˆusername éŒ¯èª¤ / æœªåŠ å…¥ Repo / æˆ–å¡«å¯«ç‚º emailï¼‰";
              if (assigned && desiredAssignees.length === 1 && !isEmail(desiredAssignees[0])) {
                mentionLine = `@${desiredAssignees[0]}`;
              } else if (assigned && (inputOwner && isEmail(inputOwner))) {
                mentionLine = `âš ï¸ ä½ å¡«çš„æ˜¯ emailï¼ˆGitHub ç„¡æ³• @emailï¼‰ï¼Œå·²è‡ªå‹•æŒ‡æ´¾ï¼š${fallbackAssignees.map(u => `@${u}`).join(" ")}`;
              }

              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issue.data.number,
                body: [
                  mentionLine,
                  ``,
                  `è«‹å®Œæˆ **${desc}**`,
                  ``,
                  `ğŸ“ è³‡æ–™å¤¾ï¼š`,
                  folderUrl,
                  ``,
                  `ğŸ‘¤ ä½ å¡«çš„è² è²¬äººï¼š`,
                  inputOwner || "ï¼ˆæœªå¡«ï¼‰",
                  ``,
                  `âœ… å¯¦éš›æŒ‡æ´¾ï¼š`,
                  usedAssignees.length ? usedAssignees.join(", ") : "ï¼ˆæœªè‡ªå‹•æŒ‡æ´¾ï¼Œè«‹æ‰‹å‹•ä¿®æ­£ assigneeï¼‰",
                ].join("\n")
                });
            }
